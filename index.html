<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TUATTF 練習スケジュール</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #f9fafb;
        color: #1f2937;
    }
    
    .container {
        max-width: 800px;
    }
    
    .card {
        transition: all 0.2s ease;
        border-radius: 0.5rem;
        overflow: hidden;
        margin-bottom: 0.75rem;
        border: 1px solid #e5e7eb;
        background-color: white;
    }
    
    .card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .today-card {
        border-left: 4px solid #2563eb;
        background-color: #f0f9ff;
    }
    
    .month-tabs {
        display: flex;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        margin-bottom: 1.5rem;
        padding: 0.5rem 0;
    }
    
    .month-tabs::-webkit-scrollbar {
        display: none;
    }
    
    .month-tab {
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        margin-right: 0.5rem;
        font-size: 0.875rem;
        cursor: pointer;
        white-space: nowrap;
        background-color: #e5e7eb;
        color: #4b5563;
        transition: all 0.2s ease;
    }
    
    .month-tab:hover {
        background-color: #d1d5db;
    }
    
    .month-tab.active {
        background-color: #2563eb;
        color: white;
        font-weight: 500;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #1f2937;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .loader {
        width: 2.5rem;
        height: 2.5rem;
        border: 0.25rem solid #e5e7eb;
        border-radius: 50%;
        border-top-color: #2563eb;
        animation: spin 1s linear infinite;
        margin: 2rem auto;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .details.active {
        max-height: 500px;
    }
    
    .date-badge {
        background-color: #e5e7eb;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 500;
        font-size: 0.875rem;
    }
    
    .location-badge {
        background-color: #f3f4f6;
        color: #4b5563;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }
    
    .detail-label {
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }
    
    .detail-content {
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }
    
    .error-message {
        padding: 1rem;
        text-align: center;
        background-color: #fee2e2;
        border: 1px solid #fecaca;
        color: #b91c1c;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }
    
    .empty-message {
        padding: 1rem;
        text-align: center;
        background-color: #f3f4f6;
        border: 1px solid #e5e7eb;
        color: #6b7280;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }
  </style>
</head>
<body class="min-h-screen">
  <header class="bg-white shadow-sm py-4 sticky top-0 z-10">
    <div class="container mx-auto px-4">
      <h1 class="text-xl font-bold">TUATTF 練習スケジュール</h1>
    </div>
  </header>
  <main class="container mx-auto px-4 py-6">
    <div id="currentDate" class="text-sm text-gray-500 mb-4"></div>
    <div id="monthTabs" class="month-tabs"></div>
    <div id="todaySection" class="mb-8">
      <h2 class="section-title">今日の練習</h2>
      <div id="todaySchedule"><div class="loader"></div></div>
    </div>
    <div id="scheduleSection">
      <h2 id="scheduleTitle" class="section-title">練習予定</h2>
      <div id="scheduleList"><div class="loader"></div></div>
    </div>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // DOM取得
    const currentDateElement = document.getElementById('currentDate');
    const monthTabsElement   = document.getElementById('monthTabs');
    const todaySection       = document.getElementById('todaySection');
    const todayScheduleElem  = document.getElementById('todaySchedule');
    const scheduleTitleElem  = document.getElementById('scheduleTitle');
    const scheduleListElem   = document.getElementById('scheduleList');

    // 現在日時
    const now          = new Date();
    const currentYear  = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    const currentDate  = now.getDate();
    currentDateElement.textContent = `${currentYear}年${currentMonth}月${currentDate}日`;

    const spreadsheetId = '1utxuwDZsrLZ5cTq8uIPRdOmMvlE9O1IbE1ymsIey3Uo';
    let selectedMonth   = currentMonth;
    
    // タイムアウト処理用の変数
    let fetchTimeoutId = null;

    initMonthTabs();
    loadMonthData(selectedMonth);

    function initMonthTabs() {
      monthTabsElement.innerHTML = '';
      for (let m = 1; m <= 12; m++) {
        const tab = document.createElement('div');
        tab.className = `month-tab ${m===selectedMonth?'active':''}`;
        tab.textContent = `${m}月`;
        tab.dataset.month = m;
        tab.addEventListener('click', () => {
          if (+tab.dataset.month === selectedMonth) return;
          selectedMonth = +tab.dataset.month;
          scheduleTitleElem.textContent = `${selectedMonth}月の練習予定`;
          document.querySelectorAll('.month-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          clearContent();
          loadMonthData(selectedMonth);
        });
        monthTabsElement.appendChild(tab);
      }
      // 中央スクロール
      setTimeout(()=>{
        const active = monthTabsElement.querySelector('.month-tab.active');
        active && active.scrollIntoView({ inline:'center', behavior:'smooth' });
      },100);
    }

    function clearContent() {
      // タイムアウトがあれば解除
      if (fetchTimeoutId) {
        clearTimeout(fetchTimeoutId);
        fetchTimeoutId = null;
      }
      
      todayScheduleElem.innerHTML = '<div class="loader"></div>';
      scheduleListElem.innerHTML = '<div class="loader"></div>';
      todaySection.style.display = selectedMonth===currentMonth ? 'block' : 'none';
    }

    function loadMonthData(month) {
      clearContent();
      
      // 10秒後にタイムアウトエラーを表示
      fetchTimeoutId = setTimeout(() => {
        showFetchError(month, 'データの取得がタイムアウトしました。インターネット接続を確認するか、後でもう一度お試しください。');
      }, 10000);
      
      const namesToTry = [ `${month}月メニュー` ];
      if (month < 10) namesToTry.push(`0${month}月メニュー`);
      _tryFetch(namesToTry, 0);
    }

    function _tryFetch(names, idx) {
      if (idx >= names.length) {
        showSheetNotFoundError(selectedMonth);
        clearTimeout(fetchTimeoutId);
        fetchTimeoutId = null;
        return;
      }
      const sheetName = names[idx];
      const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      
      fetch(url)
        .then(res => {
          if (!res.ok) {
            throw res.status;
          }
          return res.text();
        })
        .then(text => {
          // タイムアウトを解除
          clearTimeout(fetchTimeoutId);
          fetchTimeoutId = null;

          if (/no such sheet|Invalid query parameter value/i.test(text)) {
            return _tryFetch(names, idx+1);
          }
          
          // Google Sheetsのレスポンス形式の対応を強化
          // 1. "/*O_o*/google.visualization.Query.setResponse(" で始まるパターン
          let jsonText = '';
          const stdPattern = /setResponse\(([\s\S]+)\);?$/;
          const m = text.match(stdPattern);
          
          if (m) {
            jsonText = m[1];
          } else {
            // 2. JSONを直接探すパターン
            const jsonStart = text.indexOf('{');
            const jsonEnd = text.lastIndexOf('}') + 1;
            if (jsonStart >= 0 && jsonEnd > jsonStart) {
              jsonText = text.substring(jsonStart, jsonEnd);
            } else {
              throw new Error('Invalid GViz response format');
            }
          }
          
          try {
            const jsonData = JSON.parse(jsonText);
            
            if (jsonData.status === 'error' || !jsonData.table?.rows) {
              return _tryFetch(names, idx+1);
            }
            
            if (jsonData.table.rows.length <= 1) {
              showEmptyDataMessage(month);
            } else {
              processSheetData(jsonData.table.rows, month);
            }
          } catch (e) {
            console.error('JSON解析エラー:', e, '\n応答テキスト:', text.substring(0, 200) + '...');
            throw new Error('Failed to parse JSON: ' + e.message);
          }
        })
        .catch(err => {
          console.error('Fetch error:', err);
          
          // タイムアウトを解除
          clearTimeout(fetchTimeoutId);
          fetchTimeoutId = null;
          
          if (typeof err === 'number' && err === 404) {
            _tryFetch(names, idx+1);
          } else if (err.message && err.message.includes('Invalid GViz')) {
            _tryFetch(names, idx+1);
          } else if (err.message && err.message.includes('parse JSON')) {
            showProcessingError(month, 'データの形式が不正です: ' + err.message);
          } else {
            showFetchError(month);
          }
        });
    }

    function processSheetData(rows, month) {
      try {
        const items = [];
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (!row.c || !row.c[0]?.v) continue;
          
          // 時間または場所が空の場合はスキップ
          if (!row.c[2]?.v || !row.c[3]?.v) continue;
          
          const val = row.c[0].v;
          let dateObj;
          let day = null;
          
          if (typeof val === 'object' && val && val.getDate) {
            // Dateオブジェクトの場合
            dateObj = val;
            day = dateObj.getDate();
          } else if (row.c[0].f) {
            // "6月1日(月)" などをパース
            const fm = row.c[0].f.match(/(\d+)月\s*(\d+)日/);
            if (fm) {
              day = parseInt(fm[2], 10);
            }
          } else if (typeof val === 'string') {
            // "5/1" などの文字列
            const parts = val.split('/');
            if (parts.length === 2) {
              day = parseInt(parts[1], 10);
            }
          } else if (typeof val === 'number') {
            // 数値の可能性もある（シリアル値）
            const tempDate = new Date(1899, 11, 30);
            tempDate.setDate(tempDate.getDate() + val);
            day = tempDate.getDate();
          }
          
          if (!day || isNaN(day)) continue;
          
          // 当月分は過去日を除外
          if (month === currentMonth && day < currentDate) continue;

          items.push({
            dateStr: `${month}/${day}`,
            dayOfWeek: row.c[1]?.f || row.c[1]?.v || '',
            time:        row.c[2]?.v || '',
            location:    row.c[3]?.v || '',
            menu:        row.c[4]?.v || '',
            pace:        row.c[5]?.v || '',
            strengthening: row.c[6]?.v || '',
            notes:       row.c[7]?.v || '',
            day
          });
        }
        
        if (items.length === 0) {
          showEmptyDataMessage(month);
          return;
        }
        
        // 直近順ソート
        items.sort((a,b) => a.day - b.day);

        const todayItems = [], otherItems = [];
        const todayKey = `${currentMonth}/${currentDate}`;
        items.forEach(it => {
          if (month === currentMonth && it.dateStr === todayKey) todayItems.push(it);
          else otherItems.push(it);
        });

        if (todayItems.length > 0) {
          displayScheduleItems(todayItems, todayScheduleElem, true);
        } else if (month === currentMonth) {
          todayScheduleElem.innerHTML = '<div class="empty-message">今日の練習予定はありません</div>';
        }

        if (otherItems.length > 0) {
          displayScheduleItems(otherItems, scheduleListElem, false);
        } else {
          scheduleListElem.innerHTML = '<div class="empty-message">練習予定はありません</div>';
        }
      } catch (e) {
        console.error('データ処理エラー:', e);
        showProcessingError(month, 'データの処理中にエラーが発生しました: ' + e.message);
      }
    }

    function displayScheduleItems(list, container, isToday) {
      container.innerHTML = '';
      list.forEach((it, idx) => {
        const id = `${isToday?'today':'sch'}-${idx}`;
        const card = document.createElement('div');
        card.className = `card ${isToday?'today-card':''}`;
        card.innerHTML = `
          <div class="p-4 cursor-pointer" onclick="toggleDetails('${id}')">
            <div class="flex justify-between items-center">
              <div class="flex items-center space-x-4">
                <span class="date-badge">${it.dateStr} (${it.dayOfWeek})</span>
                <span class="text-sm">${it.time}</span>
              </div>
              <div class="flex items-center">
                <span class="location-badge mr-2">${it.location}</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" id="icon-${id}" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>
          </div>
          <div id="details-${id}" class="details border-t">
            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50">
              <div>
                <div class="detail-label">練習メニュー</div>
                <div class="detail-content">${it.menu||'情報なし'}</div>
                <div class="detail-label">ペース</div>
                <div class="detail-content">${it.pace||'情報なし'}</div>
              </div>
              <div>
                <div class="detail-label">補強</div>
                <div class="detail-content">${it.strengthening||'情報なし'}</div>
                <div class="detail-label">補足</div>
                <div class="detail-content">${it.notes||'情報なし'}</div>
              </div>
            </div>
          </div>`;
        container.appendChild(card);
      });
    }

    function showSheetNotFoundError(month) {
      const errorMessage = `「${month}月メニュー」というシートが見つかりませんでした。シート名を確認してください。`;
      
      if (month === currentMonth) {
          todayScheduleElem.innerHTML = `<div class="error-message">${errorMessage}</div>`;
      }
      
      scheduleListElem.innerHTML = `<div class="error-message">${errorMessage}</div>`;
    }
    
    function showEmptyDataMessage(month) {
      if (month === currentMonth) {
          todayScheduleElem.innerHTML = '<div class="empty-message">練習データがありません</div>';
      }
      
      scheduleListElem.innerHTML = '<div class="empty-message">練習データがありません</div>';
    }
    
    function showProcessingError(month, message = 'データの処理中にエラーが発生しました。データ形式を確認してください。') {
      if (month === currentMonth) {
          todayScheduleElem.innerHTML = `<div class="error-message">${message}</div>`;
      }
      
      scheduleListElem.innerHTML = `<div class="error-message">${message}</div>`;
    }
    
    function showFetchError(month, message = 'データの取得に失敗しました。ネットワーク接続とスプレッドシートの共有設定を確認してください。') {
      if (month === currentMonth) {
          todayScheduleElem.innerHTML = `<div class="error-message">${message}</div>`;
      }
      
      scheduleListElem.innerHTML = `<div class="error-message">${message}</div>`;
    }

    // 詳細の切り替え関数をグローバルスコープに追加
    window.toggleDetails = function(id) {
      const det = document.getElementById(`details-${id}`);
      const ico = document.getElementById(`icon-${id}`);
      if (det.classList.contains('active')) {
        det.classList.remove('active');
        ico.innerHTML = '<path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>';
      } else {
        det.classList.add('active');
        ico.innerHTML = '<path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"/>';
      }
    };
  });
  </script>
</body>
</html>
